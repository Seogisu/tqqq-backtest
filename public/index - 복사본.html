<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQQQ 장 구분 백테스트</title>
    <style>
        /* ... (CSS 스타일은 이전과 동일하므로 생략) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-section {
            padding: 40px;
            background: #f8f9fa;
        }

        /* New style for Current Phase Display */
        .current-phase-box {
            background: #e9ecef; /* Light gray background */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .current-phase-box h3 {
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 10px;
        }

        .current-phase-status {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
            padding: 10px 0;
        }

        .current-phase-detail {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Color classes for status */
        .current-phase-box.bull { background: #d4edda; border-color: #c3e6cb; }
        .current-phase-box.bear { background: #f8d7da; border-color: #f5c6cb; }
        .current-phase-box.reentry { background: #fff3cd; border-color: #ffeeba; }
        .current-phase-box.momentum, .current-phase-box.momentum2 { background: #d1ecf1; border-color: #bee5eb; }
        .current-phase-box.unknown, .current-phase-box.error { background: #e9ecef; border-color: #dee2e6; }

        .current-phase-status.bull { color: #155724; }
        .current-phase-status.bear { color: #721c24; }
        .current-phase-status.reentry { color: #856404; }
        .current-phase-status.momentum, .current-phase-status.momentum2 { color: #0c5460; }
        .current-phase-status.unknown, .current-phase-status.error { color: #6c757d; }
        /* End New style */

        .info-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        /* 새로운 장 구분 설정 테이블 스타일 */
        .phase-config-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            background: white;
            font-size: 0.9em;
        }

        .phase-config-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }

        .phase-config-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .phase-config-table select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .info-box .header-row { /* 새로운 Flexbox 컨테이너 스타일 */
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
        }

        /* 장 구분 설정 스타일 끝 */

        .phase-table { /* 기존 장 구분 테이블 스타일은 삭제하지 않고 유지 */
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            background: white;
            font-size: 0.9em;
        }

        .phase-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }

        .phase-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .phase-bull { background: #d4edda; }
        .phase-bear { background: #f8d7da; }
        .phase-reentry { background: #fff3cd; }
        .phase-momentum { background: #d1ecf1; }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .allocation-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .allocation-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        /* 모멘텀2를 위한 스타일 조정 */
        .allocation-section .allocation-grid:nth-child(2) {
             grid-template-columns: repeat(1, 1fr);
             max-width: 330px; /* Adjust width for single column card */
        }
        @media (min-width: 1200px) {
            .allocation-section .allocation-grid:nth-child(2) {
                grid-template-columns: repeat(4, 1fr);
                max-width: none;
            }
        }
        /* End 모멘텀2를 위한 스타일 조정 */

        .allocation-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
        }

        .allocation-card h4 {
            margin-bottom: 10px;
            font-size: 1em;
            text-align: center;
        }

        .allocation-card.bull { border-color: #28a745; background: #d4edda; }
        .allocation-card.bear { border-color: #dc3545; background: #f8d7da; }
        .allocation-card.reentry { border-color: #ffc107; background: #fff3cd; }
        .allocation-card.momentum { border-color: #17a2b8; background: #d1ecf1; }

        .allocation-input {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .allocation-input label {
            flex: 1;
            font-size: 0.9em;
        }

        .allocation-input input {
            width: 70px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: right;
        }
        
        .allocation-input .cash-value {
            width: 70px;
            padding: 5px;
            text-align: right;
            font-weight: bold;
            color: #28a745; /* 현금은 기본적으로 초록색 */
        }
        /* 현금 값이 마이너스일 때 (초과 배분) 빨간색으로 표시 */
        .allocation-input .cash-value.negative {
            color: #dc3545;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .view-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .view-btn {
            padding: 12px 30px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* 기본 설정 버튼 스타일 조정 */
        .info-box .view-btn {
            padding: 8px 15px;
            font-size: 0.9em;
        }


        .view-btn:hover {
            background: #f0f0f0;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .summary-cards {
            display: grid;
            /* 4개 카드를 위한 레이아웃 조정 */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table td {
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        /* 장 구분 색상 클래스 */
        .phase-bull-cell {
            background: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }

        .phase-bear-cell {
            background: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }

        .phase-reentry-cell {
            background: #fff3cd !important;
            color: #856404;
            font-weight: bold;
        }

        .phase-momentum-cell, .phase-momentum2-cell { /* 모멘텀2 추가 */
            background: #d1ecf1 !important;
            color: #0c5460;
            font-weight: bold;
        }
        /* 장 구분 색상 클래스 끝 */

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .spinner-small { /* 현재 장 상황 표시용 작은 스피너 */
             width: 25px;
             height: 25px;
             margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
            display: none;
        }

        .error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 TQQQ 장 구분 백테스트</h1>
            <p>이동평균선 기반 장 상황별 포트폴리오 리밸런싱 전략</p>
        </div>

        <div class="form-section">
            
            <div class="current-phase-box" id="currentPhaseBox">
                <h3>현재 장 상황 확인 중...</h3>
                <span class="current-phase-status" style="font-size: 1.5em;"><div class="spinner spinner-small"></div></span>
            </div>
            <div class="info-box">
                <div class="header-row">
                    <h3>📈 장 구분 기준 설정 (TQQQ 기준)</h3>
                    <button type="button" id="btnDefaultMa" class="view-btn">기본 설정으로</button>
                </div>
                
                <p style="margin-bottom: 10px; font-size: 0.85em; color: #555;">TQQQ 주가가 각 이동평균선(MA) 대비 **위(Above), 아래(Below), 해당없음(Any)** 중 어떤 상태일 때 해당 장으로 판단할지 설정하세요.</p>
                
                <table class="phase-config-table">
                    <thead>
                        <tr>
                            <th>장 구분</th>
                            <th>1000 SMA</th>
                            <th>200 SMA</th>
                            <th>20 SMA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>상승장 (Bull)</strong></td>
                            <td><select id="ma1000-bull"><option value="any" selected>해당없음</option><option value="above">위</option><option value="below">아래</option></select></td>
                            <td><select id="ma200-bull"><option value="any">해당없음</option><option value="above" selected>위</option><option value="below">아래</option></select></td>
                            <td><select id="ma20-bull"><option value="any" selected>해당없음</option><option value="above">위</option><option value="below">아래</option></select></td>
                        </tr>
                        <tr>
                            <td><strong>하락장 (Bear)</strong></td>
                            <td><select id="ma1000-bear"><option value="any" selected>해당없음</option><option value="above">위</option><option value="below">아래</option></select></td>
                            <td><select id="ma200-bear"><option value="any">해당없음</option><option value="above">위</option><option value="below" selected>아래</option></select></td>
                            <td><select id="ma20-bear"><option value="any" selected>해당없음</option><option value="above">위</option><option value="below">아래</option></select></td>
                        </tr>
                        <tr>
                            <td><strong>재진입 (Re-entry)</strong></td>
                            <td><select id="ma1000-reentry"><option value="any">해당없음</option><option value="above">위</option><option value="below" selected>아래</option></select></td>
                            <td><select id="ma200-reentry"><option value="any">해당없음</option><option value="above">위</option><option value="below" selected>아래</option></select></td>
                            <td><select id="ma20-reentry"><option value="any">해당없음</option><option value="above">위</option><option value="below" selected>아래</option></select></td>
                        </tr>
                        <tr>
                            <td><strong>모멘텀 (Momentum)</strong></td>
                            <td><select id="ma1000-momentum"><option value="any">해당없음</option><option value="above" selected>위</option><option value="below">아래</option></select></td>
                            <td><select id="ma200-momentum"><option value="any">해당없음</option><option value="above">위</option><option value="below" selected>아래</option></select></td>
                            <td><select id="ma20-momentum"><option value="any">해당없음</option><option value="above" selected>위</option><option value="below">아래</option></select></td>
                        </tr>
                        <tr>
                            <td><strong>모멘텀2 (Momentum2)</strong></td>
                            <td><select id="ma1000-momentum2"><option value="any">해당없음</option><option value="above">위</option><option value="below" selected>아래</option></select></td>
                            <td><select id="ma200-momentum2"><option value="any">해당없음</option><option value="above" selected>위</option><option value="below">아래</option></select></td>
                            <td><select id="ma20-momentum2"><option value="any">해당없음</option><option value="above" selected>위</option><option value="below">아래</option></select></td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top: 10px; font-size: 0.85em; color: #555;">* Momentum, Momentum2는 임의로 지정된 장입니다. 모든 조건을 Any로 설정하여 비활성화하거나, 원하는 다른 조합을 정의할 수 있습니다. **장 판단은 설정된 순서대로 진행됩니다.**</p>
            </div>

            <div class="error" id="error"></div>

            <form id="backtestForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>종목 1 (Stock1)</label>
                        <input type="text" id="stock1" placeholder="예: TQQQ" value="TQQQ" required>
                    </div>
                    <div class="form-group">
                        <label>종목 2 (Stock2)</label>
                        <input type="text" id="stock2" placeholder="예: SQQQ" value="SQQQ" required>
                    </div>
                    <div class="form-group">
                        <label>시작일</label>
                        <input type="date" id="startDate" value="2020-01-01" required>
                    </div>
                    <div class="form-group">
                        <label>종료일</label>
                        <input type="date" id="endDate" required>
                    </div>
                    <div class="form-group">
                        <label>초기 투자금 (USD)</label>
                        <input type="number" id="initialCash" placeholder="10000" value="10000" min="1" required>
                    </div>
                </div>

                <div class="allocation-section">
                    <h3>장 상황별 포트폴리오 배분 (%) - 현금은 자동 계산됩니다.</h3>
                    <div class="allocation-grid">
                        <div class="allocation-card bull">
                            <h4>🟢 상승장</h4>
                            <div class="allocation-input">
                                <label class="stock1-label">Stock1</label>
                                <input type="number" id="bull-stock1" value="100" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label class="stock2-label">Stock2</label>
                                <input type="number" id="bull-stock2" value="0" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label>현금</label>
                                <span id="bull-cash-display" class="cash-value"></span>
                                <span>%</span>
                            </div>
                        </div>

                        <div class="allocation-card bear">
                            <h4>🔴 하락장</h4>
                            <div class="allocation-input">
                                <label class="stock1-label">Stock1</label>
                                <input type="number" id="bear-stock1" value="0" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label class="stock2-label">Stock2</label>
                                <input type="number" id="bear-stock2" value="10" min="0" max="100">
                                <span>%</span>
                            </div>
                             <div class="allocation-input">
                                <label>현금</label>
                                <span id="bear-cash-display" class="cash-value"></span>
                                <span>%</span>
                            </div>
                        </div>

                        <div class="allocation-card reentry">
                            <h4>🟡 재진입</h4>
                            <div class="allocation-input">
                                <label class="stock1-label">Stock1</label>
                                <input type="number" id="reentry-stock1" value="10" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label class="stock2-label">Stock2</label>
                                <input type="number" id="reentry-stock2" value="0" min="0" max="100">
                                <span>%</span>
                            </div>
                             <div class="allocation-input">
                                <label>현금</label>
                                <span id="reentry-cash-display" class="cash-value"></span>
                                <span>%</span>
                            </div>
                        </div>

                        <div class="allocation-card momentum">
                            <h4>🔵 모멘텀전환</h4>
                            <div class="allocation-input">
                                <label class="stock1-label">Stock1</label>
                                <input type="number" id="momentum-stock1" value="30" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label class="stock2-label">Stock2</label>
                                <input type="number" id="momentum-stock2" value="0" min="0" max="100">
                                <span>%</span>
                            </div>
                             <div class="allocation-input">
                                <label>현금</label>
                                <span id="momentum-cash-display" class="cash-value"></span>
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;" class="allocation-grid">
                        <div class="allocation-card momentum">
                            <h4>🔵 모멘텀2</h4>
                            <div class="allocation-input">
                                <label class="stock1-label">Stock1</label>
                                <input type="number" id="momentum2-stock1" value="30" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label class="stock2-label">Stock2</label>
                                <input type="number" id="momentum2-stock2" value="0" min="0" max="100">
                                <span>%</span>
                            </div>
                            <div class="allocation-input">
                                <label>현금</label>
                                <span id="momentum2-cash-display" class="cash-value"></span>
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">백테스트 실행</button>
            </form>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>백테스트 실행 중... (데이터 수집 및 분석)</p>
        </div>

        <div class="results-section" id="results">
            <h2 style="margin-bottom: 20px;">백테스트 결과</h2>
            
            <div class="summary-cards" id="summaryResults">
                </div>

            <div class="view-selector">
                <button class="view-btn active" id="btnDaily">영업일별</button>
                <button class="view-btn" id="btnMonthly">월별</button>
                <button class="view-btn" id="btnYearly">연별</button>
            </div>

            <h3 style="margin-bottom: 15px;" id="tableTitle">영업일별 포트폴리오 현황</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>장구분</th>
                            <th>TQQQ<br>주가</th>
                            <th id="stock1Header">Stock1<br>주가</th>
                            <th id="stock1ValueHeader">Stock1<br>평가액</th>
                            <th id="stock2Header">Stock2<br>주가</th>
                            <th id="stock2ValueHeader">Stock2<br>평가액</th>
                            <th>현금</th>
                            <th>총 평가액</th>
                            <th>수익률</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        const STORAGE_KEY = 'tqqqBacktestSettings'; // 로컬 스토리지 키 정의
        const PHASES = ['bull', 'bear', 'reentry', 'momentum', 'momentum2'];
        
        // **새로 정의된 기본 MA 설정값**
        const DEFAULT_MA_CONFIG = {
            bull: { ma1000: 'any', ma200: 'above', ma20: 'any' },
            bear: { ma1000: 'any', ma200: 'below', ma20: 'any' },
            reentry: { ma1000: 'below', ma200: 'below', ma20: 'below' },
            momentum: { ma1000: 'above', ma200: 'below', ma20: 'above' },
            momentum2: { ma1000: 'below', ma200: 'above', ma20: 'above' }
        };
        // **MA 설정값 끝**

        function getYesterdayDate() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1); 
            const year = yesterday.getFullYear();
            const month = String(yesterday.getMonth() + 1).padStart(2, '0');
            const day = String(yesterday.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateAllocationLabels() {
            const stock1Ticker = document.getElementById('stock1').value.toUpperCase() || 'Stock1';
            const stock2Ticker = document.getElementById('stock2').value.toUpperCase() || 'Stock2';

            document.querySelectorAll('.stock1-label').forEach(label => {
                label.textContent = stock1Ticker;
            });

            document.querySelectorAll('.stock2-label').forEach(label => {
                label.textContent = stock2Ticker;
            });
        }
        
        /**
         * 주식 비율을 기반으로 현금 비율을 계산하고 화면에 표시합니다.
         * @param {string} phase 장 구분 키 ('bull', 'bear', ...)
         * @returns {number} 계산된 현금 비율 (음수일 수 있음)
         */
        function updateCashDisplay(phase) {
            // NaN 방지를 위해 || 0 추가
            const stock1 = parseFloat(document.getElementById(`${phase}-stock1`).value) || 0;
            const stock2 = parseFloat(document.getElementById(`${phase}-stock2`).value) || 0;
            
            // 현금 비율 자동 계산 (100%를 초과하면 음수)
            const cash = 100 - stock1 - stock2;
            
            const cashDisplayEl = document.getElementById(`${phase}-cash-display`);
            
            // 현금 표시 및 색상 변경
            cashDisplayEl.textContent = cash.toFixed(0); 
            cashDisplayEl.classList.remove('negative');
            if (cash < 0) {
                cashDisplayEl.textContent = `-${Math.abs(cash).toFixed(0)}`;
                cashDisplayEl.classList.add('negative');
            }
            
            return cash;
        }

        function initializeCashDisplays() {
            PHASES.forEach(updateCashDisplay);
        }

        function getAllocationAndMaConfig() {
            const maConfig = {};
            const allocation = {};

            PHASES.forEach(phase => {
                maConfig[phase] = {
                    ma1000: document.getElementById(`ma1000-${phase}`).value,
                    ma200: document.getElementById(`ma200-${phase}`).value,
                    ma20: document.getElementById(`ma20-${phase}`).value,
                };
                
                const stock1 = parseFloat(document.getElementById(`${phase}-stock1`).value);
                const stock2 = parseFloat(document.getElementById(`${phase}-stock2`).value);
                
                // 현금 자동 계산
                const cash = 100 - stock1 - stock2;

                allocation[phase] = {
                    stock1: stock1,
                    stock2: stock2,
                    cash: cash, // 서버에 계산된 현금 비율 전달
                };
            });

            return { maConfig, allocation };
        }
        
        /**
         * 장 구분 기준을 미리 정의된 기본값으로 되돌리고 화면을 업데이트합니다.
         */
        function setDefaultMaConfig() {
            const defaultSettings = DEFAULT_MA_CONFIG;
            
            PHASES.forEach(phase => {
                const config = defaultSettings[phase];
                if (config) {
                    if (document.getElementById(`ma1000-${phase}`)) document.getElementById(`ma1000-${phase}`).value = config.ma1000;
                    if (document.getElementById(`ma200-${phase}`)) document.getElementById(`ma200-${phase}`).value = config.ma200;
                    if (document.getElementById(`ma20-${phase}`)) document.getElementById(`ma20-${phase}`).value = config.ma20;
                }
            });
            
            alert("장 구분 기준이 기본 설정으로 초기화되었습니다.");
        }
        
        /**
         * 현재의 모든 설정값을 로컬 스토리지에 저장합니다.
         */
        function saveSettings() {
            const settings = {};

            // 1. General Settings
            settings.general = {
                stock1: document.getElementById('stock1').value,
                stock2: document.getElementById('stock2').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                initialCash: document.getElementById('initialCash').value,
            };

            // 2. MA Config
            settings.maConfig = {};
            PHASES.forEach(phase => {
                settings.maConfig[phase] = {
                    ma1000: document.getElementById(`ma1000-${phase}`).value,
                    ma200: document.getElementById(`ma200-${phase}`).value,
                    ma20: document.getElementById(`ma20-${phase}`).value,
                };
            });

            // 3. Allocation Config
            settings.allocation = {};
            PHASES.forEach(phase => {
                settings.allocation[phase] = {
                    stock1: document.getElementById(`${phase}-stock1`).value,
                    stock2: document.getElementById(`${phase}-stock2`).value,
                };
            });

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch (e) {
                console.warn("로컬 스토리지에 설정을 저장할 수 없습니다.", e);
            }
        }
        
        /**
         * 로컬 스토리지에서 설정값을 불러와 폼을 채웁니다.
         * @returns {boolean} 설정 로드 성공 여부
         */
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(STORAGE_KEY);
                if (!storedSettings) return false;

                const settings = JSON.parse(storedSettings);

                // 1. General Settings
                if (settings.general) {
                    document.getElementById('stock1').value = settings.general.stock1 || 'TQQQ';
                    document.getElementById('stock2').value = settings.general.stock2 || 'SQQQ';
                    document.getElementById('startDate').value = settings.general.startDate || '2020-01-01';
                    document.getElementById('endDate').value = settings.general.endDate || getYesterdayDate();
                    document.getElementById('initialCash').value = settings.general.initialCash || '10000';
                }

                // 2. MA Config
                if (settings.maConfig) {
                    PHASES.forEach(phase => {
                        const config = settings.maConfig[phase];
                        if (config) {
                            if (document.getElementById(`ma1000-${phase}`)) document.getElementById(`ma1000-${phase}`).value = config.ma1000;
                            if (document.getElementById(`ma200-${phase}`)) document.getElementById(`ma200-${phase}`).value = config.ma200;
                            if (document.getElementById(`ma20-${phase}`)) document.getElementById(`ma20-${phase}`).value = config.ma20;
                        }
                    });
                } else {
                     // 저장된 설정이 없으면 MA는 디폴트 값으로 설정
                     setDefaultMaConfig();
                }

                // 3. Allocation Config
                if (settings.allocation) {
                    PHASES.forEach(phase => {
                        const alloc = settings.allocation[phase];
                        if (alloc) {
                            if (document.getElementById(`${phase}-stock1`)) document.getElementById(`${phase}-stock1`).value = alloc.stock1;
                            if (document.getElementById(`${phase}-stock2`)) document.getElementById(`${phase}-stock2`).value = alloc.stock2;
                        }
                    });
                }
                
                return true;

            } catch (e) {
                console.error("로컬 스토리지 설정 로드 실패:", e);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. 로컬 스토리지에서 설정 로드
            const settingsLoaded = loadSettings();

            // 2. 설정이 로드되지 않았거나 종료일이 비어있으면 기본값 설정 (어제 날짜)
            if (!settingsLoaded || !document.getElementById('endDate').value) {
                document.getElementById('endDate').value = getYesterdayDate();
            }

            // 3. 종목 라벨 및 현금 비율 표시 업데이트 (로드된 값 기반)
            updateAllocationLabels();
            initializeCashDisplays(); 

            // 4. 현재 장 상황 로드
            fetchCurrentPhase();
            
            // 5. 이벤트 리스너 추가
            document.getElementById('btnDefaultMa').addEventListener('click', setDefaultMaConfig); // **새로 추가된 버튼 리스너**

            // 주식 비율 입력 시 현금 비율 실시간 업데이트 리스너 추가
            PHASES.forEach(phase => {
                document.getElementById(`${phase}-stock1`).addEventListener('input', () => updateCashDisplay(phase));
                document.getElementById(`${phase}-stock2`).addEventListener('input', () => updateCashDisplay(phase));
            });
        });


        document.getElementById('stock1').addEventListener('input', updateAllocationLabels);
        document.getElementById('stock2').addEventListener('input', updateAllocationLabels);

        document.getElementById('backtestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            updateAllocationLabels(); 
            
            const stock1Ticker = document.getElementById('stock1').value.toUpperCase();
            const stock2Ticker = document.getElementById('stock2').value.toUpperCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const initialCash = document.getElementById('initialCash').value;
            
            const { maConfig, allocation } = getAllocationAndMaConfig();
            
            // **배분 유효성 검사**
            let isValid = true;
            let errorMsg = '';

            for (const phase of PHASES) {
                // Cash가 음수인지 확인 (Stock1 + Stock2 > 100 인 경우)
                if (allocation[phase].cash < 0) {
                    const totalStock = allocation[phase].stock1 + allocation[phase].stock2;
                    errorMsg = `${phase} 장 상황의 주식 배분 합계(${totalStock}%)가 100%를 초과할 수 없습니다. (현금 비율: ${allocation[phase].cash}%)`;
                    isValid = false;
                    break;
                }
            }

            if (!isValid) {
                document.getElementById('error').textContent = `오류: ${errorMsg}`;
                document.getElementById('error').classList.add('show');
                return;
            }

            // **성공적인 실행 전, 현재 설정값을 로컬 스토리지에 저장**
            saveSettings();

            document.getElementById('error').classList.remove('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('submitBtn').disabled = true;

            try {
                const response = await fetch('/api/advanced-backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stock1Ticker,
                        stock2Ticker,
                        startDate,
                        endDate,
                        initialCash,
                        allocation,
                        maConfig // maConfig를 서버로 전송
                    })
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                currentData = data;
                displayResults(data, 'daily');

            } catch (error) {
                document.getElementById('error').textContent = `오류: ${error.message}`;
                document.getElementById('error').classList.add('show');
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;
            }
        });

        document.getElementById('btnDaily').addEventListener('click', () => changeView('daily'));
        document.getElementById('btnMonthly').addEventListener('click', () => changeView('monthly'));
        document.getElementById('btnYearly').addEventListener('click', () => changeView('yearly'));

        function changeView(view) {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
            
            if (currentData) {
                displayTable(currentData, view);
            }
        }

        // 💡 수정된 displayResults 함수: 요약 카드를 동적으로 생성하고 주가 상승률을 추가합니다.
        function displayResults(data, view) {
            document.getElementById('stock1Header').innerHTML = `${data.stock1Ticker}<br>주가`;
            document.getElementById('stock1ValueHeader').innerHTML = `${data.stock1Ticker}<br>평가액`;
            document.getElementById('stock2Header').innerHTML = `${data.stock2Ticker}<br>주가`;
            document.getElementById('stock2ValueHeader').innerHTML = `${data.stock2Ticker}<br>평가액`;
            
            const totalReturnClass = data.summary.totalReturn >= 0 ? 'positive' : 'negative';
            const profitClass = data.summary.profit >= 0 ? 'positive' : 'negative';
            const priceReturnClass = data.summary.stock1PriceReturn >= 0 ? 'positive' : 'negative';

            const summaryHtml = `
                <div class="summary-card">
                    <h3>최종 평가금액</h3>
                    <div class="value">$${data.summary.finalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                </div>
                <div class="summary-card">
                    <h3>총 수익률</h3>
                    <div class="value ${totalReturnClass}">${data.summary.totalReturn.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%</div>
                </div>
                <div class="summary-card">
                    <h3>손익</h3>
                    <div class="value ${profitClass}">$${data.summary.profit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                </div>
                <div class="summary-card">
                    <h3>${data.stock1Ticker} 주가상승률</h3>
                    <div class="value ${priceReturnClass}">${data.summary.stock1PriceReturn.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%</div>
                </div>
            `;
            
            // 기존의 하드코딩된 요약 카드 영역 대신 동적으로 생성된 HTML을 삽입
            document.getElementById('summaryResults').innerHTML = summaryHtml; 

            displayTable(data, view);
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayTable(data, view) {
            let resultsData, title;
            if (view === 'daily') {
                resultsData = data.dailyResults;
                title = '영업일별 포트폴리오 현황';
            } else if (view === 'monthly') {
                resultsData = data.monthlyResults;
                title = '월별 포트폴리오 현황';
            } else {
                resultsData = data.yearlyResults;
                title = '연별 포트폴리오 현황';
            }

            document.getElementById('tableTitle').textContent = title;
            const tableBody = document.getElementById('resultsTable');
            tableBody.innerHTML = '';

            resultsData.forEach(row => {
                const tr = document.createElement('tr');
                const returnClass = row.returnRate >= 0 ? 'positive' : 'negative';
                
                const phaseClass = row.phaseKey ? `phase-${row.phaseKey}-cell` : '';
                
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td class="${phaseClass}"><strong>${row.phase}</strong></td>
                    <td>${row.tqqqPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${row.stock1Price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${row.stock1Value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${row.stock2Price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${row.stock2Value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${row.cash.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td><strong>${row.totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td class="${returnClass}">${row.returnRate.toFixed(2)}%</td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        /**
         * 현재 장 상황 정보를 서버로부터 가져와서 화면에 표시합니다.
         */
        function fetchCurrentPhase() {
            const boxEl = document.getElementById('currentPhaseBox');
            const loadingHtml = `
                <h3>현재 장 상황 확인 중...</h3>
                <span class="current-phase-status" style="font-size: 1.5em;"><div class="spinner spinner-small"></div></span>
            `;
            boxEl.innerHTML = loadingHtml;
            boxEl.className = 'current-phase-box'; // 로딩 중에는 기본 스타일 유지

            fetch('/api/current-phase')
                .then(response => {
                    if (!response.ok) {
                         // 서버 에러도 json 형태로 예상하고 처리
                         return response.json().catch(() => ({ success: false, message: '서버 연결 실패.' }));
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const html = `
                            <h3>📊 ${data.date} 기준 현재 장 상황 (TQQQ)</h3>
                            <span class="current-phase-status ${data.phaseKey}">${data.phaseName}</span>
                            <p class="current-phase-detail">
                                TQQQ: $${data.tqqqPrice} | MA20: $${data.ma20} | MA200: $${data.ma200} | MA1000: $${data.ma1000}
                            </p>
                        `;
                        boxEl.innerHTML = html;
                        boxEl.className = `current-phase-box ${data.phaseKey}`;
                    } else {
                        const html = `
                            <h3>⚠️ 현재 장 상황 확인 불가</h3>
                            <span class="current-phase-status error" style="font-size: 1.5em;">${data.message || '오류 발생'}</span>
                        `;
                        boxEl.innerHTML = html;
                        boxEl.className = `current-phase-box error`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching current phase:', error);
                    boxEl.innerHTML = `
                        <h3>⚠️ 현재 장 상황 확인 실패</h3>
                        <span class="current-phase-status error" style="font-size: 1.5em;">네트워크 오류 또는 서버 응답 문제</span>
                    `;
                    boxEl.className = `current-phase-box error`;
                });
        }
    </script>
</body>
</html>